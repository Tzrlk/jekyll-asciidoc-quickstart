<!doctype html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title itemprop="name">Tzrlk: Installing RancherOS on Bare Metal</title>

	<meta name="description" itemprop="description"
	      content="The personal site of Peter Cummuskey" />

	<meta name="author" itemprop="author"
	      content="Peter Cummuskey" />

	<meta name="copyright"
	      content="Peter Cummuskey 2016" />

	<!-- Assets -->
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
	      integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
	      crossorigin="anonymous" />

	<!-- CONSIDER SWITCHING TO http://bulma.io/
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.1/css/bulma.min.css"
	      integrity="sha256-n+Ch7oRdzZ9+8/inp+1mK/0Bt4T/2PSmo4L6YGoDiVM="
	      crossorigin="anonymous" />-->

	<!-- Styles -->
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css"
	      integrity="sha256-HxaKz5E/eBbvhGMNwhWRPrAR9i/lG1JeT4mD6hCQ7s4="
	      crossorigin="anonymous" />
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"
	      integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w="
	      crossorigin="anonymous" />
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/css/bootstrap-material-design.min.css"
	      integrity="sha256-j3CLSRG31GkOu6kaeLh7XsRgL2YNvRl9aOtXoAYt320="
	      crossorigin="anonymous" />
	<link rel="stylesheet"
	      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/css/ripples.min.css"
	      integrity="sha256-+Og2qJI9qzvKYwhGo/LYXg0FzE1BhEQfDsUSjKXQ3Bg="
	      crossorigin="anonymous" />
	<link rel="stylesheet"
	      href="https://cdn.rawgit.com/richleland/pygments-css/master/tango.css" />

</head>
<body>


<!-- Nav Bar -->

<nav class="navbar navbar-default" data-topbar>
	<div class="container-fluid">

		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-top" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">Tzrlk</a>
		</div>

		<div class="collapse navbar-collapse" id="nav-top">
			<ul class="nav navbar-nav">

				<li role="presentation">
					<a href="/about">About Me</a>
				</li>

			</ul>
		</div>

	</div>
</nav>
<!-- End Nav -->


<div class="container-fluid">

	<aside class="col-md-3 col-lg-2">
		<div class="row">

			<nav class="col-xs-12 col-sm-4 col-md-12">
				<h4>Contents</h4>
				<div id="toc"></div>
			</nav>

			<section class="col-xs-12 col-sm-4 col-md-12">
				<h4>Flair</h4>
				<a href="https://stackexchange.com/users/18122" class="panel">
					<img src="https://stackexchange.com/users/flair/18122.png?theme=clean"
					     width="208" height="58" alt="Tzrlk on Stackexchange"/>
				</a>
			</section>

		</div>
	</aside>

	<main class="col-md-9 col-lg-10" role="content">
		<div class="container" style="margin-left: 0;">

			<div class="post" itemscope itemtype="http://schema.org/BlogPosting">

	<header class="post-header">
		<h1 class="post-title" itemprop="name">Installing RancherOS on Bare Metal</h1>
		<p class="post-meta">
			<meta itemprop="keywords" content="" />
			<span itemprop="author" itemscope itemtype="http://schema.org/Person">
				<a href="/about" rel="author" itemprop="url">Peter Cummuskey</a>
			</span>
			<span class="hyphen">-</span>
			<time itemprop="datePublished" datetime="2017-06-12T14:55:24+12:00">
				Jun 12, 2017
			</time>
		</p>
	</header>

	<article class="post-content" itemprop="articleBody">
		<p>Getting RancherOS installed on bare metal is a pain if you don’t know all the steps. I had to figure these out from the various bits of documentation scattered-around the place. Docker + corporate proxy = a pain in the ass.</p>

<h2 id="setup">Setup</h2>

<ol>
  <li>
    <dl>
      <dt>Download the iso</dt>
      <dd>Just grab the latest iso from the <a href="https://github.com/rancher/os/releases">RancherOS github releases</a>.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Install it to bootable media</dt>
      <dd>This can be done via a number of means. I originally ran <a href="https://rufus.akeo.ie/">Rufus</a> to do the job</dd>
      <dd>With subsequent installs I’ll be going with <code class="highlighter-rouge">dd if=rancheros.iso of=/dev/sdx</code> (where <code class="highlighter-rouge">sdx</code> is whatever the usb device is).</dd>
      <dd>Apparently <a href="http://clonezilla.org/">Clonezilla</a> is also an option, but the simplicity of <code class="highlighter-rouge">dd</code> makes it pretty damn appealing.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Boot the OS</dt>
      <dd>Just make sure that the system will accept booting from the usb drive. This may require turning-off secure boot and using the legacy features.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Change the rancher password</dt>
      <dd>Just run <code class="highlighter-rouge">sudo passwd rancher</code>, followed by something like <code class="highlighter-rouge">password</code> and <code class="highlighter-rouge">password</code>. Ignore the errors, it should work just fine regardless. Once done, you’ll be able to ssh and scp into the box just fine.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Set up the cloud-config.yml file</dt>
      <dd>Put whatever config you need in a cloud-config.yml file, and get it onto the box via ssh or scp.</dd>
      <dd>You can do all the configuration via <code class="highlighter-rouge">sudo ros config set</code>, but that can become a pain <em>really</em> quickly, so it’s just easier to write it once and use <code class="highlighter-rouge">sudo ros config validate -i cloud-config.yml</code> and <code class="highlighter-rouge">sudo ros config merge -i cloud-config.yml</code> to apply it. I’ll put a sample config below.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Wipe the hd partitions</dt>
      <dd>This is fairly easy, as a simple <code class="highlighter-rouge">sudo fdisk /dev/sda &lt;enter&gt; d &lt;enter&gt; w</code>, should wipe the partition table for the primary HD, making it ready for install.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Pull the latest os installer image</dt>
      <dd>Assuming you’ve updated the relevant network settings, you can make sure they’re applied by running <code class="highlighter-rouge">sudo system-docker restart docker</code>, <code class="highlighter-rouge">sudo system-docker restart network</code>, then running <code class="highlighter-rouge">docker pull rancher/os:vX.X.X</code> and/or <code class="highlighter-rouge">sudo system-docker pull rancher/os:vX.X.X</code>.</dd>
      <dd>Alternately <code class="highlighter-rouge">docker save</code> and <code class="highlighter-rouge">docker load</code> 
 combined with <code class="highlighter-rouge">scp</code> can be used to bypass <code class="highlighter-rouge">docker pull</code> if that’s being a pain.</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Run the ros installer on the hd</dt>
      <dd>The final step, you should have a <code class="highlighter-rouge">cloud-config.yml</code> available, as well as the <code class="highlighter-rouge">rancher/os:vX.X.X</code> image pulled to the repo. Now you just need to run <code class="highlighter-rouge">sudo ros install -i rancher/os:vX.X.X -c cloud-config.yml -d /dev/sda</code> and wait for it to finish and reboot.</dd>
    </dl>
  </li>
</ol>

<h2 id="config-example">Config Example</h2>

<p>This is an obfuscated version of my current working config, so some of it may or may not be necessary for your purposes (or even at all). As far as I know, there’s no variable substitution, so replace all the <code class="highlighter-rouge">${...}</code> instances with actual values (hence <code class="highlighter-rouge">PROXY_HTTP</code> instead of <code class="highlighter-rouge">HTTP_PROXY</code>).</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">rancher</span><span class="pi">:</span>

  <span class="s">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">EXTRA_CMDLINE=/init</span>
    <span class="pi">-</span> <span class="s">HTTP_PROXY=${PROXY_HTTP}</span>
    <span class="pi">-</span> <span class="s">HTTPS_PROXY=${PROXY_HTTPS}</span>
    <span class="pi">-</span> <span class="s">NO_PROXY=${PROXY_EXCLUDE}</span>

  <span class="s">network</span><span class="pi">:</span>
    <span class="s">dns</span><span class="pi">:</span>
      <span class="s">nameservers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">${DNS_IP_1}</span>
        <span class="pi">-</span> <span class="s">${DNS_IP_2}</span>
      <span class="s">search</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">${COMPANYDOMAIN_LOCAL}</span>
    <span class="s">interfaces</span><span class="pi">:</span>
      <span class="s">eth0</span><span class="pi">:</span>
        <span class="s">dhcp</span><span class="pi">:</span>    <span class="s">true</span>
        <span class="s">gateway</span><span class="pi">:</span> <span class="s">${GATEWAY_IP}</span>
    <span class="s">http_proxy</span><span class="pi">:</span>  <span class="s">${PROXY_HTTP}</span>
    <span class="s">https_proxy</span><span class="pi">:</span> <span class="s">${PROXY_HTTPS}</span>
    <span class="s">no_proxy</span><span class="pi">:</span>    <span class="s">${PROXY_EXCLUDE}</span>

  <span class="s">services</span><span class="pi">:</span>

    <span class="c1"># If you're using convoy</span>
    <span class="s">convoy</span><span class="pi">:</span>
      <span class="s">name</span><span class="pi">:</span>  <span class="s">convoy</span>
      <span class="s">image</span><span class="pi">:</span> <span class="s">evansgp/convoy-daemon:latest</span>
      <span class="s">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">daemon</span>
        <span class="pi">-</span> <span class="s">--drivers     devicemapper</span>
        <span class="pi">-</span> <span class="s">--driver-opts dm.datadev=/dev/sdb1</span>
        <span class="pi">-</span> <span class="s">--driver-opts dm.metadatadev=/dev/sdb2</span>
      <span class="s">privileged</span><span class="pi">:</span> <span class="s">true</span>
      <span class="s">restart</span><span class="pi">:</span>    <span class="s">always</span>
      <span class="s">labels</span><span class="pi">:</span>
        <span class="s">io.rancher.os.scope</span><span class="pi">:</span> <span class="s">system</span>
        <span class="s">io.rancher.os.after</span><span class="pi">:</span> <span class="s">docker</span>
      <span class="s">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
        <span class="pi">-</span> <span class="s">/etc/docker/plugins:/etc/docker/plugins</span>
        <span class="pi">-</span> <span class="s">/dev/sdb1:/dev/sdb1</span>
        <span class="pi">-</span> <span class="s">/dev/sdb2:/dev/sdb2</span>
      <span class="s">volumes_from</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">all-volumes</span>

    <span class="s">rancher-agent</span><span class="pi">:</span>
      <span class="s">name</span><span class="pi">:</span>        <span class="s">rancher-agent</span>
      <span class="s">image</span><span class="pi">:</span>       <span class="s">rancher/agent:v1.2.2</span>
      <span class="s">command</span><span class="pi">:</span>     <span class="s">http://${RANCHER_HOST_PORT}/v1/scripts/${RANCHER_CODE}</span>
      <span class="s">privileged</span><span class="pi">:</span>  <span class="s">true</span>
      <span class="s">autodestroy</span><span class="pi">:</span> <span class="s">always</span>
      <span class="s">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
      <span class="s">labels</span><span class="pi">:</span>
        <span class="s">io.rancher.os.after</span><span class="pi">:</span> <span class="s">docker</span>

  <span class="s">services_include</span><span class="pi">:</span>
    <span class="s">rancher-server</span><span class="pi">:</span> <span class="s">true</span>

  <span class="s">system_docker</span><span class="pi">:</span>
    <span class="s">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">HTTP_PROXY=${PROXY_HTTP}</span>
    <span class="pi">-</span> <span class="s">HTTPS_PROXY=${PROXY_HTTPS}</span>
    <span class="pi">-</span> <span class="s">NO_PROXY=${PROXY_EXCLUDE}</span>

<span class="s">write_files</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="s">path</span><span class="pi">:</span> <span class="s">/opt/rancher/bin/start.sh</span>
    <span class="s">permissions</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0755"</span>
    <span class="s">owner</span><span class="pi">:</span> <span class="s">root</span>
    <span class="s">content</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="no">#!/bin/bash</span>
      <span class="no">alias convoy='sudo system-docker exec -it --privileged convoy convoy'</span>

<span class="s">ssh_authorized_keys</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">${PUBLIC_KEY_1}</span>
  <span class="pi">-</span> <span class="s">${PUBLIC_KEY_2}</span> <span class="c1"># etc.</span>

</code></pre>
</div>

	</article>

</div>


		</div>
	</main>

</div>


<footer class="container-fluid">
	<div class="col-xs-12">
		<div class="row">

			<ol class="breadcrumb">
				<li><a href="http://aetheric.co.nz/">Aetheric Engineering</a></li>
				<li><a href="">Tzrlk</a></li>
				<li class="active">Installing RancherOS on Bare Metal: </li>
			</ol>

		</div>
	</div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

<!-- Polyfills -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"
        integrity="sha256-0rguYS0qgS6L4qVzANq4kjxPLtvnp5nn2nB5G1lWRv4="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"
        integrity="sha256-t6SrqvTQmKoGgi5LOl0AUy+lBRtIvEJ+++pLAsfAjWs="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-placeholder/2.3.1/jquery.placeholder.min.js"
        integrity="sha256-vo4hFjZ2XisF8ql7P6kGVCDAbuW68h6P2WunwD+QI54="
        crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/js/material.min.js"
        integrity="sha256-uZbIqasulk7Y9yEwknbeQ0FpF3aUhtPwuggbpvQaI8Y="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.10/js/ripples.min.js"
        integrity="sha256-TY/EO/++Ug/P+fSBjaqlmtuphCBKwlP7TOnS+SGnN8g="
        crossorigin="anonymous"></script>

<script src="/js/toc.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	$('#toc').toc({
		headers: 'h2, h3',
		listClasses: 'nav nav-pills nav-stacked'
	});
});
</script>

</body>
</html>
